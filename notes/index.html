<!DOCTYPE html>
<html lang="he">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>HiveNote</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;500;600;700&family=DM+Sans:opsz,wght@9..40,300;9..40,400;9..40,500&family=DM+Mono&display=swap" rel="stylesheet">
<style>
/* â”€â”€ RESET â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
html,body{height:100%;overflow:hidden}

/* â”€â”€ TOKENS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
:root{
  --honey:#f5a623;
  --honey-deep:#d4881a;
  --honey-light:#ffd97d;
  --honey-pale:#fff8e7;
  --honey-glow:rgba(245,166,35,0.22);
  --charcoal:#1c1a17;
  --charcoal2:#2a2720;
  --charcoal3:#3a3630;
  --cream:#fdf6e3;
  --cream2:#f5ead0;
  --wax:#e8d5a3;
  --text:#1c1a17;
  --text2:#6b5f45;
  --text3:#a89876;
  --surface:#ffffff;
  --surface2:#fdf6e3;
  --border:rgba(180,140,60,0.18);
  --border-strong:rgba(180,140,60,0.35);
  --bubble-own:#ffffff;
  --bubble-ltr:#fff8e7;
  --shadow:0 2px 14px rgba(180,120,0,0.10);
  --shadow-lg:0 8px 36px rgba(180,120,0,0.16);
  --radius:18px;
  --ease-spring:cubic-bezier(0.34,1.56,0.64,1);
  --ease-out:cubic-bezier(0.22,1,0.36,1);
  --font:'DM Sans',sans-serif;
  --head:'Syne',sans-serif;
  --mono:'DM Mono',monospace;
  --cat-work:#dbeafe;--cat-work-c:#1d4ed8;
  --cat-personal:#fce7f3;--cat-personal-c:#be185d;
  --cat-todo:#ede9fe;--cat-todo-c:#6d28d9;
  --cat-urgent:#ffedd5;--cat-urgent-c:#c2410c;
}
body.dark{
  --surface:#1c1a17;
  --surface2:#2a2720;
  --cream:#2a2720;
  --cream2:#3a3630;
  --border:rgba(245,166,35,0.15);
  --border-strong:rgba(245,166,35,0.3);
  --text:#f0e6cc;
  --text2:#c4a86a;
  --text3:#6b5f45;
  --bubble-own:#2a2720;
  --bubble-ltr:#221f18;
  --shadow:0 2px 14px rgba(0,0,0,0.35);
  --shadow-lg:0 8px 36px rgba(0,0,0,0.4);
  --cat-work:#0d1b35;--cat-work-c:#60a5fa;
  --cat-personal:#2e0d1a;--cat-personal-c:#f472b6;
  --cat-todo:#1a1035;--cat-todo-c:#a78bfa;
  --cat-urgent:#2e1200;--cat-urgent-c:#fb923c;
}

body{
  font-family:var(--font);
  background:var(--cream);
  color:var(--text);
  display:flex;flex-direction:column;
  transition:background .3s,color .3s;
}

/* â”€â”€ HEX TEXTURE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
body::before{
  content:'';position:fixed;inset:0;pointer-events:none;z-index:0;
  background-image:url("data:image/svg+xml,%3Csvg width='60' height='52' viewBox='0 0 60 52' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M15 0 L45 0 L60 26 L45 52 L15 52 L0 26Z' fill='none' stroke='%23f5a623' stroke-width='0.4' stroke-opacity='0.08'/%3E%3Cpath d='M75 0 L105 0 L120 26 L105 52 L75 52 L60 26Z' fill='none' stroke='%23f5a623' stroke-width='0.4' stroke-opacity='0.08'/%3E%3Cpath d='M-15 0 L15 0 L30 26 L15 52 L-15 52 L-30 26Z' fill='none' stroke='%23f5a623' stroke-width='0.4' stroke-opacity='0.08'/%3E%3Cpath d='M45 26 L75 26 L90 52 L75 78 L45 78 L30 52Z' fill='none' stroke='%23f5a623' stroke-width='0.4' stroke-opacity='0.08'/%3E%3Cpath d='M-15 26 L15 26 L30 52 L15 78 L-15 78 L-30 52Z' fill='none' stroke='%23f5a623' stroke-width='0.4' stroke-opacity='0.08'/%3E%3C/svg%3E");
  opacity:1;
}

/* â”€â”€ LOCK SCREEN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#lockScreen{
  position:fixed;inset:0;z-index:9999;
  background:var(--charcoal);
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  gap:0;
}
#lockScreen.hidden{display:none;}

.lock-logo{
  display:flex;align-items:center;gap:10px;
  margin-bottom:36px;
}
.lock-bee{font-size:2.4rem;animation:beewiggle 3s ease-in-out infinite;}
@keyframes beewiggle{0%,100%{transform:rotate(-8deg);}50%{transform:rotate(8deg);}}
.lock-title{font-family:var(--head);font-size:1.8rem;font-weight:700;color:#fff;letter-spacing:-0.5px;}
.lock-title span{color:var(--honey);}

.lock-sub{font-size:.85rem;color:var(--text3);margin-bottom:32px;letter-spacing:.3px;}

.pin-dots{display:flex;gap:14px;margin-bottom:36px;}
.pin-dot{
  width:14px;height:14px;border-radius:50%;
  border:2px solid var(--charcoal3);
  background:transparent;
  transition:background .2s var(--ease-spring),transform .2s var(--ease-spring);
}
.pin-dot.filled{background:var(--honey);border-color:var(--honey);transform:scale(1.15);}

.pin-grid{
  display:grid;grid-template-columns:repeat(3,1fr);gap:10px;
  max-width:240px;width:100%;
}
.pin-key{
  height:64px;border-radius:16px;
  background:var(--charcoal2);border:1px solid var(--charcoal3);
  font-family:var(--head);font-size:1.4rem;font-weight:600;color:#fff;
  cursor:pointer;transition:all .12s var(--ease-spring);
  display:flex;align-items:center;justify-content:center;
  user-select:none;
}
.pin-key:hover{background:var(--charcoal3);transform:scale(1.04);}
.pin-key:active{transform:scale(.95);background:var(--honey);color:var(--charcoal);}
.pin-key.wide{grid-column:1/-1;font-size:1rem;height:52px;color:var(--text3);}
.pin-key.wide:hover{color:#fff;}

.pin-error{
  color:#f87171;font-size:.82rem;margin-top:16px;
  animation:shake .3s ease;height:20px;
}
@keyframes shake{0%,100%{transform:translateX(0);}25%{transform:translateX(-6px);}75%{transform:translateX(6px);}}

/* first-time setup */
.pin-setup-msg{color:var(--honey);font-size:.8rem;margin-top:12px;text-align:center;max-width:220px;}

/* â”€â”€ TOPBAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.topbar{
  position:relative;z-index:10;
  background:var(--charcoal);
  height:56px;
  display:flex;align-items:center;padding:0 14px;gap:10px;
  flex-shrink:0;
  box-shadow:0 2px 16px rgba(0,0,0,0.25);
}
.tb-logo{display:flex;align-items:center;gap:8px;flex:1;}
.tb-bee{font-size:1.3rem;line-height:1;}
.tb-title{font-family:var(--head);font-size:1rem;font-weight:700;color:#fff;letter-spacing:-.2px;}
.tb-title span{color:var(--honey);}
.tb-clock{font-family:var(--mono);font-size:.7rem;color:rgba(255,255,255,.45);white-space:nowrap;}
.tb-actions{display:flex;align-items:center;gap:2px;}
.tb-btn{
  width:36px;height:36px;border-radius:10px;border:none;
  background:transparent;cursor:pointer;color:rgba(255,255,255,.7);
  display:flex;align-items:center;justify-content:center;font-size:1rem;
  transition:background .15s,color .15s,transform .15s var(--ease-spring);
}
.tb-btn:hover{background:rgba(255,255,255,.1);color:#fff;transform:scale(1.08);}
.tb-btn:active{transform:scale(.93);}
.save-dot{
  width:7px;height:7px;border-radius:50%;background:#3ecf8e;
  transition:background .3s,transform .3s;
}
.save-dot.saving{background:var(--honey);transform:scale(1.4);}
.save-dot.err{background:#f87171;}

/* â”€â”€ SEARCH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.search-bar{
  position:relative;z-index:10;
  background:var(--surface);border-bottom:1px solid var(--border);
  padding:7px 12px;display:flex;gap:8px;align-items:center;flex-shrink:0;
}
.search-inner{
  flex:1;display:flex;align-items:center;gap:8px;
  background:var(--surface2);border-radius:12px;padding:0 12px;height:34px;
  border:1.5px solid transparent;transition:border .2s,box-shadow .2s;
}
.search-inner:focus-within{border-color:var(--honey);box-shadow:0 0 0 3px var(--honey-glow);}
.search-inner svg{color:var(--text3);flex-shrink:0;}
#searchInput{flex:1;border:none;background:transparent;outline:none;font-family:var(--font);font-size:.88rem;color:var(--text);}
#searchInput::placeholder{color:var(--text3);}
#searchClear{background:none;border:none;cursor:pointer;color:var(--text3);font-size:1rem;padding:0;display:none;transition:color .15s;}
#searchClear:hover{color:#f87171;}
#searchClear.vis{display:block;}
.sort-btn{
  background:var(--surface2);border:1.5px solid var(--border);
  border-radius:10px;padding:0 10px;height:34px;
  font-family:var(--font);font-size:.73rem;font-weight:500;
  color:var(--text2);cursor:pointer;white-space:nowrap;
  transition:all .15s;display:flex;align-items:center;gap:4px;
}
.sort-btn:hover{border-color:var(--honey);color:var(--honey);}

/* â”€â”€ FILTER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.filter-bar{
  position:relative;z-index:10;
  background:var(--surface);border-bottom:1px solid var(--border);
  padding:0 12px;height:40px;
  display:flex;align-items:center;gap:6px;
  overflow-x:auto;flex-shrink:0;scrollbar-width:none;
}
.filter-bar::-webkit-scrollbar{display:none;}
.f-chip{
  height:26px;padding:0 12px;border-radius:20px;
  border:1.5px solid var(--border);background:transparent;
  font-size:.72rem;font-weight:600;font-family:var(--font);
  color:var(--text2);cursor:pointer;white-space:nowrap;flex-shrink:0;
  transition:all .18s var(--ease-spring);display:flex;align-items:center;gap:5px;
}
.f-chip .dot{width:6px;height:6px;border-radius:50%;background:currentColor;}
.f-chip:hover{border-color:var(--honey);color:var(--honey);transform:translateY(-1px);}
.f-chip.active{background:var(--honey);border-color:var(--honey);color:var(--charcoal);transform:translateY(-1px);box-shadow:0 2px 8px var(--honey-glow);}
.f-chip.active .dot{background:var(--charcoal);}
.f-chip.fw.active{background:var(--cat-work-c);border-color:var(--cat-work-c);color:#fff;}
.f-chip.fp.active{background:var(--cat-personal-c);border-color:var(--cat-personal-c);color:#fff;}
.f-chip.ft.active{background:var(--cat-todo-c);border-color:var(--cat-todo-c);color:#fff;}
.f-chip.fu.active{background:var(--cat-urgent-c);border-color:var(--cat-urgent-c);color:#fff;}

/* â”€â”€ PINNED â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.pinned-strip{
  background:var(--honey-pale);border-bottom:1px solid var(--honey-light);
  padding:6px 12px;flex-shrink:0;display:none;
}
body.dark .pinned-strip{background:#1e1a00;border-bottom-color:#3a3200;}
.pinned-strip.vis{display:block;}
.pinned-lbl{font-size:.63rem;font-weight:700;letter-spacing:.7px;color:var(--honey-deep);text-transform:uppercase;margin-bottom:4px;}
.pinned-row{display:flex;gap:6px;overflow-x:auto;scrollbar-width:none;}
.pinned-row::-webkit-scrollbar{display:none;}
.pinned-card{
  background:rgba(245,166,35,.12);border:1px solid rgba(245,166,35,.3);
  border-radius:10px;padding:4px 10px;font-size:.75rem;color:var(--honey-deep);
  white-space:nowrap;max-width:180px;overflow:hidden;text-overflow:ellipsis;
  display:flex;align-items:center;gap:6px;flex-shrink:0;cursor:default;
}
.pinned-card button{background:none;border:none;cursor:pointer;color:var(--honey-deep);opacity:.6;font-size:.8rem;padding:0;transition:opacity .15s;}
.pinned-card button:hover{opacity:1;}

/* â”€â”€ FEED â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#feed{
  flex:1;overflow-y:auto;padding:12px 10px 8px;
  display:flex;flex-direction:column;gap:2px;
  overscroll-behavior:contain;scroll-behavior:smooth;
  position:relative;z-index:1;
}
#feed::-webkit-scrollbar{width:3px;}
#feed::-webkit-scrollbar-thumb{background:var(--wax);border-radius:3px;}

.empty-state{
  flex:1;display:flex;flex-direction:column;
  align-items:center;justify-content:center;
  padding:40px 20px;gap:8px;
}
.empty-bee{font-size:3rem;animation:beewiggle 3s ease-in-out infinite;}
.empty-t{font-family:var(--head);font-size:1rem;font-weight:600;color:var(--text2);}
.empty-s{font-size:.8rem;color:var(--text3);}

/* â”€â”€ DATE SEP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.date-sep{display:flex;align-items:center;gap:8px;margin:12px 0 4px;}
.date-sep::before,.date-sep::after{content:'';flex:1;height:1px;background:var(--border);}
.date-lbl{
  font-size:.63rem;font-weight:700;letter-spacing:.6px;text-transform:uppercase;
  color:var(--text3);white-space:nowrap;
  background:var(--cream);padding:0 8px;
}

/* â”€â”€ MSG WRAP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.msg-wrap{
  display:flex;flex-direction:column;align-items:flex-end;padding:1px 0;
  animation:msgIn .22s var(--ease-spring);
}
.msg-wrap.ltr{align-items:flex-start;}
@keyframes msgIn{from{opacity:0;transform:translateY(8px) scale(.97);}to{opacity:1;transform:none;}}

.msg-actions{
  display:flex;gap:3px;margin-bottom:3px;flex-wrap:wrap;
  opacity:0;transform:translateY(4px);pointer-events:none;
  transition:opacity .15s,transform .15s;justify-content:flex-end;
}
.msg-wrap.ltr .msg-actions{justify-content:flex-start;}
.msg-wrap:hover .msg-actions{opacity:1;transform:none;pointer-events:all;}

.act-btn{
  height:22px;padding:0 8px;border-radius:20px;
  border:1px solid var(--border);background:var(--surface);
  font-size:.65rem;font-weight:500;font-family:var(--font);
  color:var(--text2);cursor:pointer;
  transition:all .14s var(--ease-spring);
  display:flex;align-items:center;gap:3px;
}
.act-btn:hover{background:var(--honey);color:var(--charcoal);border-color:var(--honey);transform:scale(1.05);}
.act-btn.del:hover{background:#f87171;color:#fff;border-color:#f87171;}
.act-btn.pin-b:hover{background:var(--honey-deep);color:#fff;border-color:var(--honey-deep);}

/* â”€â”€ BUBBLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.bubble{
  max-width:min(84%,480px);min-width:80px;
  background:var(--bubble-own);
  border:1px solid var(--border);
  border-radius:var(--radius) var(--radius) 4px var(--radius);
  padding:9px 12px 22px;
  position:relative;word-break:break-word;
  box-shadow:var(--shadow);
  transition:box-shadow .2s;
}
.msg-wrap.ltr .bubble{
  border-radius:var(--radius) var(--radius) var(--radius) 4px;
  background:var(--bubble-ltr);
}
.bubble:hover{box-shadow:var(--shadow-lg);}
.bubble.cat-work    {background:var(--cat-work);}
.bubble.cat-personal{background:var(--cat-personal);}
.bubble.cat-todo    {background:var(--cat-todo);}
.bubble.cat-urgent  {background:var(--cat-urgent);}

.cat-badge{
  display:inline-flex;align-items:center;gap:3px;
  font-size:.6rem;font-weight:700;letter-spacing:.4px;text-transform:uppercase;
  padding:2px 7px;border-radius:20px;margin-bottom:4px;
}
.cat-badge.work    {background:var(--cat-work-c);color:#fff;}
.cat-badge.personal{background:var(--cat-personal-c);color:#fff;}
.cat-badge.todo    {background:var(--cat-todo-c);color:#fff;}
.cat-badge.urgent  {background:var(--cat-urgent-c);color:#fff;}

.rem-badge{
  display:inline-flex;align-items:center;gap:4px;
  font-size:.63rem;font-weight:500;
  padding:2px 8px;border-radius:20px;margin-bottom:4px;
  background:#dbeafe;color:#1d4ed8;
}
.rem-badge.over{background:#fee2e2;color:#dc2626;}

.reply-quote{
  background:rgba(245,166,35,.1);border-left:3px solid var(--honey);
  border-radius:6px;padding:4px 10px;margin-bottom:6px;
  font-size:.74rem;color:var(--text2);
  overflow:hidden;text-overflow:ellipsis;white-space:nowrap;
}

.msg-text{font-size:.94rem;line-height:1.55;color:var(--text);white-space:pre-wrap;}
.msg-text.rtl{direction:rtl;text-align:right;}
.msg-text.ltr{direction:ltr;text-align:left;}

.msg-time{
  position:absolute;bottom:5px;right:10px;
  font-size:.6rem;color:var(--text3);font-family:var(--mono);
  display:flex;align-items:center;gap:3px;
}

/* image */
.bubble-img{max-width:100%;border-radius:10px;margin-bottom:4px;display:block;cursor:zoom-in;transition:opacity .15s;}
.bubble-img:hover{opacity:.88;}

/* url card */
.url-card{
  display:flex;gap:10px;background:var(--surface);border:1px solid var(--border);
  border-radius:12px;padding:9px;margin-bottom:4px;
  cursor:pointer;transition:border-color .15s,box-shadow .15s;
}
.url-card:hover{border-color:var(--honey);box-shadow:0 2px 12px var(--honey-glow);}
.url-card-img{width:48px;height:48px;border-radius:8px;object-fit:cover;background:var(--surface2);flex-shrink:0;}
.url-card-body{flex:1;overflow:hidden;display:flex;flex-direction:column;justify-content:center;gap:2px;}
.url-card-title{font-size:.8rem;font-weight:600;color:var(--text);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.url-card-desc{font-size:.7rem;color:var(--text2);overflow:hidden;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;}
.url-card-domain{font-size:.63rem;color:var(--honey-deep);font-weight:500;margin-top:1px;}

/* checklist */
.checklist{list-style:none;display:flex;flex-direction:column;gap:4px;margin-bottom:4px;}
.checklist li{display:flex;align-items:center;gap:8px;font-size:.9rem;color:var(--text);}
.checklist li input[type=checkbox]{width:16px;height:16px;accent-color:var(--honey);cursor:pointer;flex-shrink:0;}
.checklist li.done span{text-decoration:line-through;color:var(--text3);}

/* voice note */
.voice-note{
  display:flex;align-items:center;gap:10px;
  background:rgba(245,166,35,.08);border:1px solid rgba(245,166,35,.25);
  border-radius:12px;padding:8px 12px;margin-bottom:4px;min-width:180px;
}
.voice-play{
  width:32px;height:32px;border-radius:50%;
  background:var(--honey);border:none;cursor:pointer;
  display:flex;align-items:center;justify-content:center;
  color:var(--charcoal);font-size:.9rem;flex-shrink:0;
  transition:transform .15s var(--ease-spring),opacity .15s;
}
.voice-play:hover{transform:scale(1.1);}
.voice-play:active{transform:scale(.93);}
.voice-wave{flex:1;height:28px;display:flex;align-items:center;gap:2px;}
.voice-wave span{
  display:block;width:3px;border-radius:3px;
  background:var(--honey);opacity:.5;
  animation:wavebar 1.2s ease-in-out infinite;
}
.voice-wave span:nth-child(2){animation-delay:.1s;height:14px;}
.voice-wave span:nth-child(3){animation-delay:.2s;height:20px;}
.voice-wave span:nth-child(4){animation-delay:.3s;height:10px;}
.voice-wave span:nth-child(5){animation-delay:.4s;height:18px;}
.voice-wave span:nth-child(6){animation-delay:.5s;height:8px;}
.voice-wave span:nth-child(7){animation-delay:.15s;height:16px;}
.voice-wave span:nth-child(8){animation-delay:.25s;height:12px;}
@keyframes wavebar{0%,100%{height:6px;opacity:.3;}50%{opacity:.8;}}
.voice-dur{font-family:var(--mono);font-size:.68rem;color:var(--text3);flex-shrink:0;}

/* edit */
.edit-wrap{display:flex;flex-direction:column;gap:6px;}
.edit-ta{width:100%;min-height:40px;background:var(--surface2);border:1.5px solid var(--honey);border-radius:8px;padding:6px 8px;font-size:.9rem;font-family:var(--font);color:var(--text);resize:none;outline:none;}
.edit-row{display:flex;gap:6px;flex-wrap:wrap;align-items:center;}
.edit-sel,.edit-dt{border:1px solid var(--border);border-radius:8px;padding:4px 8px;font-size:.73rem;background:var(--surface2);color:var(--text);font-family:var(--font);outline:none;}
.e-save{background:var(--honey);color:var(--charcoal);border:none;border-radius:8px;padding:5px 14px;font-size:.75rem;font-weight:700;cursor:pointer;font-family:var(--font);}
.e-cancel{background:var(--surface2);color:var(--text2);border:1px solid var(--border);border-radius:8px;padding:5px 12px;font-size:.75rem;cursor:pointer;font-family:var(--font);}

/* â”€â”€ REPLY BAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#replyBar{
  display:none;background:rgba(245,166,35,.1);
  border-top:2px solid var(--honey);
  padding:5px 14px;flex-shrink:0;
  align-items:center;justify-content:space-between;gap:10px;
}
#replyBar.show{display:flex;}
.reply-txt{font-size:.78rem;color:var(--honey-deep);font-weight:500;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;flex:1;}
.reply-x{background:none;border:none;cursor:pointer;color:var(--text3);font-size:1.1rem;line-height:1;padding:0;transition:color .15s;}
.reply-x:hover{color:#f87171;}

/* â”€â”€ TEMPLATES DRAWER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#tplDrawer{
  display:none;background:var(--surface);border-top:1px solid var(--border);
  padding:9px 12px;flex-shrink:0;overflow-x:auto;gap:7px;scrollbar-width:none;
}
#tplDrawer.show{display:flex;}
#tplDrawer::-webkit-scrollbar{display:none;}
.tpl-card{
  background:var(--surface2);border:1px solid var(--border);border-radius:12px;
  padding:7px 12px;cursor:pointer;flex-shrink:0;min-width:110px;
  display:flex;flex-direction:column;gap:2px;
  transition:all .18s var(--ease-spring);
}
.tpl-card:hover{border-color:var(--honey);background:var(--honey-pale);transform:translateY(-2px);box-shadow:var(--shadow);}
.tpl-icon{font-size:1rem;}
.tpl-name{font-size:.72rem;font-weight:600;color:var(--text);}
.tpl-desc{font-size:.62rem;color:var(--text3);}

/* â”€â”€ REMINDER POPUP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#remPopup{
  display:none;position:fixed;bottom:76px;right:12px;
  background:var(--surface);border:1px solid var(--border);border-radius:16px;
  padding:14px;box-shadow:var(--shadow-lg);z-index:200;min-width:230px;
}
#remPopup.show{display:block;animation:popIn .2s var(--ease-spring);}
@keyframes popIn{from{opacity:0;transform:scale(.88) translateY(10px);}to{opacity:1;transform:none;}}
.popup-t{font-family:var(--head);font-size:.85rem;font-weight:600;margin-bottom:10px;color:var(--text);}
.popup-dt{width:100%;border:1px solid var(--border);border-radius:10px;padding:7px 10px;font-size:.83rem;background:var(--surface2);color:var(--text);outline:none;font-family:var(--font);margin-bottom:10px;}
.popup-row{display:flex;gap:6px;justify-content:flex-end;}
.pop-ok{background:var(--honey);color:var(--charcoal);border:none;border-radius:8px;padding:6px 14px;font-size:.78rem;font-weight:700;cursor:pointer;font-family:var(--font);}
.pop-cancel{background:var(--surface2);color:var(--text2);border:1px solid var(--border);border-radius:8px;padding:6px 12px;font-size:.78rem;cursor:pointer;font-family:var(--font);}

/* â”€â”€ INPUT SHELL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.input-shell{
  background:var(--surface);border-top:1px solid var(--border);
  padding:8px 10px 10px;flex-shrink:0;
  position:relative;z-index:10;
}
.cat-row{display:flex;gap:5px;margin-bottom:7px;overflow-x:auto;scrollbar-width:none;}
.cat-row::-webkit-scrollbar{display:none;}
.cat-tag{
  height:24px;padding:0 10px;border-radius:20px;
  border:1.5px solid var(--border);background:transparent;
  font-size:.68rem;font-weight:600;font-family:var(--font);
  color:var(--text3);cursor:pointer;white-space:nowrap;flex-shrink:0;
  transition:all .15s var(--ease-spring);
}
.cat-tag:hover{border-color:var(--honey);color:var(--honey);}
.cat-tag.active{color:var(--charcoal);border-color:transparent;transform:scale(1.06);}
.cat-tag.general.active{background:var(--honey);}
.cat-tag.work.active   {background:var(--cat-work-c);color:#fff;}
.cat-tag.personal.active{background:var(--cat-personal-c);color:#fff;}
.cat-tag.todo.active   {background:var(--cat-todo-c);color:#fff;}
.cat-tag.urgent.active {background:var(--cat-urgent-c);color:#fff;}

.input-row{display:flex;gap:7px;align-items:flex-end;}
#msgInput{
  flex:1;border:1.5px solid var(--border);border-radius:14px;
  padding:9px 13px;font-size:.94rem;font-family:var(--font);
  background:var(--surface2);color:var(--text);
  outline:none;resize:none;max-height:96px;line-height:1.45;
  transition:border .2s,box-shadow .2s;
}
#msgInput:focus{border-color:var(--honey);box-shadow:0 0 0 3px var(--honey-glow);background:var(--surface);}
#msgInput::placeholder{color:var(--text3);}
.input-tools{display:flex;gap:5px;align-items:center;}
.tool-btn{
  width:38px;height:38px;border-radius:12px;
  border:1.5px solid var(--border);background:var(--surface2);
  display:flex;align-items:center;justify-content:center;
  cursor:pointer;font-size:1rem;color:var(--text2);
  transition:all .15s var(--ease-spring);flex-shrink:0;
}
.tool-btn:hover{border-color:var(--honey);color:var(--honey);transform:scale(1.08);}
.tool-btn:active{transform:scale(.93);}
.tool-btn.active{background:rgba(245,166,35,.15);border-color:var(--honey);color:var(--honey-deep);}
#fileInput{display:none;}
#sendBtn{
  width:40px;height:40px;border-radius:13px;
  background:var(--honey);border:none;
  display:flex;align-items:center;justify-content:center;
  cursor:pointer;color:var(--charcoal);font-size:1rem;
  transition:all .15s var(--ease-spring);
  box-shadow:0 2px 10px var(--honey-glow);flex-shrink:0;
}
#sendBtn:hover{transform:scale(1.1);box-shadow:0 4px 18px var(--honey-glow);}
#sendBtn:active{transform:scale(.92);}

/* recording indicator */
.rec-indicator{
  display:none;align-items:center;gap:7px;
  font-size:.78rem;color:#f87171;font-weight:500;
  padding:4px 0;margin-bottom:6px;
}
.rec-indicator.show{display:flex;}
.rec-dot{width:8px;height:8px;border-radius:50%;background:#f87171;animation:pulse 1s ease infinite;}
@keyframes pulse{0%,100%{opacity:1;}50%{opacity:.3;}}

/* â”€â”€ OVERLAYS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.overlay{
  display:none;position:fixed;inset:0;
  background:rgba(0,0,0,.5);z-index:500;
  align-items:center;justify-content:center;padding:20px;
  backdrop-filter:blur(4px);
}
.overlay.show{display:flex;animation:fadeIn .2s;}
@keyframes fadeIn{from{opacity:0;}to{opacity:1;}}
.modal{
  background:var(--surface);border-radius:20px;padding:22px;
  max-width:380px;width:100%;max-height:82vh;overflow-y:auto;
  box-shadow:var(--shadow-lg);animation:popIn .22s var(--ease-spring);
}
.modal h3{font-family:var(--head);font-size:.95rem;font-weight:700;margin-bottom:14px;color:var(--text);}
.stat-row{display:flex;justify-content:space-between;align-items:center;padding:9px 13px;background:var(--surface2);border-radius:12px;margin-bottom:5px;}
.stat-lbl{font-size:.83rem;color:var(--text2);}
.stat-val{font-size:1.15rem;font-weight:700;color:var(--honey-deep);font-family:var(--mono);}
.modal-close{width:100%;margin-top:12px;padding:10px;background:var(--honey);color:var(--charcoal);border:none;border-radius:12px;cursor:pointer;font-size:.9rem;font-weight:700;font-family:var(--head);transition:opacity .15s;}
.modal-close:hover{opacity:.85;}

/* img preview */
.img-preview-modal img{max-width:100%;border-radius:14px;display:block;}

mark{background:rgba(245,166,35,.4);border-radius:3px;padding:0 1px;color:inherit;}

@media(max-width:480px){
  .tb-clock{display:none;}
  .bubble{max-width:88%;}
}
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• LOCK SCREEN -->
<div id="lockScreen">
  <div class="lock-logo">
    <div class="lock-bee">ğŸ</div>
    <div class="lock-title">Hive<span>Note</span></div>
  </div>
  <div class="lock-sub" id="lockSub">Enter your PIN</div>
  <div class="pin-dots" id="pinDots">
    <div class="pin-dot" id="d0"></div>
    <div class="pin-dot" id="d1"></div>
    <div class="pin-dot" id="d2"></div>
    <div class="pin-dot" id="d3"></div>
  </div>
  <div class="pin-grid" id="pinGrid">
    <button class="pin-key" onclick="pinKey('1')">1</button>
    <button class="pin-key" onclick="pinKey('2')">2</button>
    <button class="pin-key" onclick="pinKey('3')">3</button>
    <button class="pin-key" onclick="pinKey('4')">4</button>
    <button class="pin-key" onclick="pinKey('5')">5</button>
    <button class="pin-key" onclick="pinKey('6')">6</button>
    <button class="pin-key" onclick="pinKey('7')">7</button>
    <button class="pin-key" onclick="pinKey('8')">8</button>
    <button class="pin-key" onclick="pinKey('9')">9</button>
    <button class="pin-key" onclick="pinKey('del')" style="font-size:1rem">âŒ«</button>
    <button class="pin-key" onclick="pinKey('0')">0</button>
    <button class="pin-key" onclick="pinKey('ok')">OK</button>
  </div>
  <div class="pin-error" id="pinError"></div>
  <div class="pin-setup-msg" id="pinSetupMsg"></div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• TOPBAR -->
<div class="topbar">
  <div class="tb-logo">
    <div class="tb-bee">ğŸ</div>
    <div class="tb-title">Hive<span>Note</span></div>
  </div>
  <div class="tb-clock" id="clock"></div>
  <div class="tb-actions">
    <div class="save-dot" id="saveDot" title="Auto-save"></div>
    <button class="tb-btn" onclick="showStats()" title="Statistics">ğŸ“Š</button>
    <button class="tb-btn" onclick="exportPDF()" title="Export PDF">ğŸ“„</button>
    <button class="tb-btn" onclick="toggleDark()" id="themeBtn" title="Theme">ğŸŒ™</button>
    <button class="tb-btn" onclick="lockApp()" title="Lock">ğŸ”’</button>
  </div>
</div>

<!-- SEARCH -->
<div class="search-bar">
  <div class="search-inner">
    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
    <input type="text" id="searchInput" placeholder="Search notesâ€¦" oninput="onSearch(this.value)">
    <button id="searchClear" onclick="clearSearch()">âœ•</button>
  </div>
  <button class="sort-btn" onclick="toggleSort()" id="sortBtn">â†“ Newest</button>
</div>

<!-- FILTER -->
<div class="filter-bar">
  <button class="f-chip active" onclick="setFilter('all',this)"><span class="dot"></span>All</button>
  <button class="f-chip fw" onclick="setFilter('work',this)"><span class="dot" style="background:var(--cat-work-c)"></span>Work</button>
  <button class="f-chip fp" onclick="setFilter('personal',this)"><span class="dot" style="background:var(--cat-personal-c)"></span>Personal</button>
  <button class="f-chip ft" onclick="setFilter('todo',this)"><span class="dot" style="background:var(--cat-todo-c)"></span>Todo</button>
  <button class="f-chip fu" onclick="setFilter('urgent',this)"><span class="dot" style="background:var(--cat-urgent-c)"></span>Urgent</button>
</div>

<!-- PINNED -->
<div class="pinned-strip" id="pinnedStrip">
  <div class="pinned-lbl">ğŸ“Œ Pinned</div>
  <div class="pinned-row" id="pinnedRow"></div>
</div>

<!-- FEED -->
<div id="feed"></div>

<!-- REPLY BAR -->
<div id="replyBar">
  <div class="reply-txt" id="replyTxt">â†© Replyingâ€¦</div>
  <button class="reply-x" onclick="cancelReply()">âœ•</button>
</div>

<!-- TEMPLATES DRAWER -->
<div id="tplDrawer">
  <div class="tpl-card" onclick="useTpl('client')"><div class="tpl-icon">ğŸ–¥</div><div class="tpl-name">Client Visit</div><div class="tpl-desc">Site log</div></div>
  <div class="tpl-card" onclick="useTpl('problem')"><div class="tpl-icon">ğŸ”§</div><div class="tpl-name">Problem</div><div class="tpl-desc">Issue report</div></div>
  <div class="tpl-card" onclick="useTpl('network')"><div class="tpl-icon">ğŸŒ</div><div class="tpl-name">Network</div><div class="tpl-desc">Network issue</div></div>
  <div class="tpl-card" onclick="useTpl('install')"><div class="tpl-icon">ğŸ’¿</div><div class="tpl-name">Install</div><div class="tpl-desc">SW setup</div></div>
  <div class="tpl-card" onclick="useTpl('followup')"><div class="tpl-icon">ğŸ“</div><div class="tpl-name">Follow Up</div><div class="tpl-desc">Callback</div></div>
  <div class="tpl-card" onclick="useTpl('checklist')"><div class="tpl-icon">âœ…</div><div class="tpl-name">Checklist</div><div class="tpl-desc">Task list</div></div>
</div>

<!-- REMINDER POPUP -->
<div id="remPopup">
  <div class="popup-t">ğŸ”” Set Reminder</div>
  <input type="datetime-local" class="popup-dt" id="remDt">
  <div class="popup-row">
    <button class="pop-cancel" onclick="closeRem()">Cancel</button>
    <button class="pop-ok" onclick="confirmRem()">Set</button>
  </div>
</div>

<!-- INPUT -->
<div class="input-shell">
  <div class="rec-indicator" id="recInd"><div class="rec-dot"></div> Recordingâ€¦ tap ğŸ™ to stop</div>
  <div class="cat-row">
    <button class="cat-tag general active" onclick="selCat('general',this)">General</button>
    <button class="cat-tag work"     onclick="selCat('work',this)">ğŸ’¼ Work</button>
    <button class="cat-tag personal" onclick="selCat('personal',this)">ğŸ‘¤ Personal</button>
    <button class="cat-tag todo"     onclick="selCat('todo',this)">âœ… Todo</button>
    <button class="cat-tag urgent"   onclick="selCat('urgent',this)">ğŸ”¥ Urgent</button>
  </div>
  <div class="input-row">
    <textarea id="msgInput" placeholder="Write a note, paste a URLâ€¦" rows="1"></textarea>
    <div class="input-tools">
      <label class="tool-btn" title="Attach image">ğŸ“<input type="file" id="fileInput" accept="image/*" onchange="handleFile(event)"></label>
      <button class="tool-btn" id="remBtn" onclick="toggleRem()" title="Reminder">ğŸ””</button>
      <button class="tool-btn" id="tplBtn" onclick="toggleTpl()" title="Templates">ğŸ“‹</button>
      <button class="tool-btn" id="recBtn" onclick="toggleRecord()" title="Voice note">ğŸ™</button>
      <button id="sendBtn" onclick="sendMessage()">
        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
      </button>
    </div>
  </div>
</div>

<!-- MODALS -->
<div class="overlay" id="statsOverlay">
  <div class="modal">
    <h3>ğŸ“Š Statistics</h3>
    <div id="statsContent"></div>
    <button class="modal-close" onclick="closeOv('statsOverlay')">Done</button>
  </div>
</div>
<div class="overlay" id="imgOverlay" onclick="closeOv('imgOverlay')">
  <div class="img-preview-modal" style="max-width:90vw;border-radius:16px;overflow:hidden;">
    <img id="imgSrc" src="" alt="">
  </div>
</div>

<script>
// â”€â”€ PIN SYSTEM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const STORED_PIN_KEY = 'hivenote_pin';
let pinBuf = '', pinMode = 'unlock', pinSetupStep = 1, pinTemp = '';
let unlocked = false;

function initLock() {
  const stored = localStorage.getItem(STORED_PIN_KEY);
  if (!stored) {
    pinMode = 'setup1';
    document.getElementById('lockSub').textContent = 'Create a 4-digit PIN';
    document.getElementById('pinSetupMsg').textContent = 'You\'ll use this to open HiveNote';
  }
}

function pinKey(k) {
  if (k === 'del') { pinBuf = pinBuf.slice(0,-1); updateDots(); return; }
  if (k === 'ok') { submitPin(); return; }
  if (pinBuf.length >= 4) return;
  pinBuf += k; updateDots();
  if (pinBuf.length === 4) setTimeout(submitPin, 120);
}

function updateDots() {
  for(let i=0;i<4;i++) document.getElementById('d'+i).classList.toggle('filled', i < pinBuf.length);
}

function submitPin() {
  if (pinBuf.length < 4) return;
  if (pinMode === 'setup1') {
    pinTemp = pinBuf; pinBuf = '';
    pinMode = 'setup2';
    document.getElementById('lockSub').textContent = 'Confirm your PIN';
    document.getElementById('pinSetupMsg').textContent = 'Enter the same PIN again';
    updateDots(); return;
  }
  if (pinMode === 'setup2') {
    if (pinBuf === pinTemp) {
      localStorage.setItem(STORED_PIN_KEY, pinBuf);
      openApp();
    } else {
      showPinError('PINs don\'t match â€” try again');
      pinBuf = ''; pinTemp = ''; pinMode = 'setup1';
      document.getElementById('lockSub').textContent = 'Create a 4-digit PIN';
      updateDots();
    }
    return;
  }
  // unlock
  if (pinBuf === localStorage.getItem(STORED_PIN_KEY)) { openApp(); }
  else { showPinError('Wrong PIN'); pinBuf = ''; updateDots(); }
}

function showPinError(msg) {
  const el = document.getElementById('pinError');
  el.textContent = msg; el.style.animation='none';
  void el.offsetWidth; el.style.animation='shake .3s ease';
  setTimeout(()=>el.textContent='', 2000);
}

function openApp() {
  unlocked = true;
  document.getElementById('lockScreen').classList.add('hidden');
  loadNotes();
}

function lockApp() {
  unlocked = false; pinBuf = ''; pinMode = 'unlock';
  document.getElementById('lockSub').textContent = 'Enter your PIN';
  document.getElementById('pinSetupMsg').textContent = '';
  updateDots();
  document.getElementById('lockScreen').classList.remove('hidden');
}

// keyboard support for PIN
document.addEventListener('keydown', e => {
  if (unlocked) return;
  if (e.key >= '0' && e.key <= '9') pinKey(e.key);
  else if (e.key === 'Backspace') pinKey('del');
  else if (e.key === 'Enter') pinKey('ok');
});

initLock();

// â”€â”€ CLOCK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function tick() {
  const n = new Date();
  document.getElementById('clock').textContent =
    n.toLocaleDateString('he-IL') + ' Â· ' +
    n.toLocaleTimeString('he-IL',{hour:'2-digit',minute:'2-digit'});
}
setInterval(tick,1000); tick();
setInterval(checkReminders, 30000);

// â”€â”€ THEME â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let dark = localStorage.getItem('dark')==='1';
function applyTheme(){document.body.classList.toggle('dark',dark);document.getElementById('themeBtn').textContent=dark?'â˜€ï¸':'ğŸŒ™';}
function toggleDark(){dark=!dark;localStorage.setItem('dark',dark?'1':'0');applyTheme();}
applyTheme();

// â”€â”€ HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const isHeb = t=>/[\u0590-\u05FF]/.test(t);
const dir = t=>isHeb(t)?'rtl':'ltr';
const stamp = ()=>new Date().toLocaleTimeString('he-IL',{hour:'2-digit',minute:'2-digit'});
const isoNow = ()=>new Date().toISOString();
const esc = t=>t.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
const domain = url=>{try{return new URL(url).hostname.replace('www.','')}catch(e){return url}};
const isURL = t=>/^https?:\/\/\S+$/.test(t.trim());

function dateLabel(iso){
  if(!iso)return'';
  const d=new Date(iso),now=new Date();
  const diff=Math.floor((now-d)/86400000);
  if(diff===0)return'Today';if(diff===1)return'Yesterday';
  return d.toLocaleDateString('he-IL',{weekday:'long',day:'numeric',month:'long'});
}
function hl(text,q){
  if(!q)return esc(text);
  return esc(text).replace(new RegExp('('+q.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')+')','gi'),'<mark>$1</mark>');
}

// â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let notes=[],replyTo=null,activeCat='general',activeFilter='all';
let sortNewest=true,pendingReminder=null,searchQ='';

// â”€â”€ SEARCH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function onSearch(v){
  searchQ=v.trim().toLowerCase();
  document.getElementById('searchClear').classList.toggle('vis',!!v);
  renderFeed();
}
function clearSearch(){document.getElementById('searchInput').value='';onSearch('');}

// â”€â”€ SORT/FILTER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleSort(){sortNewest=!sortNewest;document.getElementById('sortBtn').textContent=sortNewest?'â†“ Newest':'â†‘ Oldest';renderFeed();}
function setFilter(cat,btn){activeFilter=cat;document.querySelectorAll('.f-chip').forEach(b=>b.classList.remove('active'));btn.classList.add('active');renderFeed();}
function selCat(cat,btn){activeCat=cat;document.querySelectorAll('.cat-tag').forEach(b=>b.classList.remove('active'));btn.classList.add('active');}

// â”€â”€ TEMPLATES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const TPLS={
  client:"ğŸ–¥ Client Visit\nClient: \nDate: \nIssue: \nActions: \nStatus: âœ… Resolved / ğŸ”„ Pending",
  problem:"ğŸ”§ Problem Report\nClient: \nDevice: \nProblem: \nRoot cause: \nSolution: \nTime: ",
  network:"ğŸŒ Network Issue\nClient: \nSymptoms: \nRouter reset: â˜\nISP contacted: â˜\nResolution: ",
  install:"ğŸ’¿ Software Install\nClient: \nDevice: \nSoftware: \nVersion: \nLicense: \nNotes: ",
  followup:"ğŸ“ Follow Up\nClient: \nLast visit: \nOpen issues: \nNext action: \nDate: ",
  checklist:"âœ… Checklist\nâ˜ \nâ˜ \nâ˜ \nâ˜ ",
};
function toggleTpl(){const d=document.getElementById('tplDrawer');d.classList.toggle('show');document.getElementById('tplBtn').classList.toggle('active',d.classList.contains('show'));}
function useTpl(k){document.getElementById('msgInput').value=TPLS[k];document.getElementById('msgInput').dispatchEvent(new Event('input'));document.getElementById('tplDrawer').classList.remove('show');document.getElementById('tplBtn').classList.remove('active');document.getElementById('msgInput').focus();}

// â”€â”€ REMINDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleRem(){const p=document.getElementById('remPopup');p.classList.toggle('show');if(p.classList.contains('show')){const n=new Date();n.setMinutes(n.getMinutes()+30);document.getElementById('remDt').value=n.toISOString().slice(0,16);}document.getElementById('remBtn').classList.toggle('active',p.classList.contains('show'));}
function closeRem(){document.getElementById('remPopup').classList.remove('show');document.getElementById('remBtn').classList.remove('active');}
function confirmRem(){const v=document.getElementById('remDt').value;if(v){pendingReminder=v;document.getElementById('remBtn').classList.add('active');}closeRem();document.getElementById('msgInput').focus();}
function checkReminders(){
  const now=new Date();
  notes.forEach(n=>{
    if(n.reminder&&!n.reminderFired&&now>=new Date(n.reminder)){
      n.reminderFired=true;
      if(Notification.permission==='granted')new Notification('ğŸ HiveNote Reminder',{body:(n.text||'').substring(0,80)});
      else alert('ğŸ”” Reminder: '+(n.text||'').substring(0,80));
      triggerSave();
    }
  });
}
if(Notification&&Notification.permission==='default')Notification.requestPermission();

// â”€â”€ VOICE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let mediaRec=null,recChunks=[],recording=false;
async function toggleRecord(){
  if(recording){stopRecord();return;}
  try{
    const stream=await navigator.mediaDevices.getUserMedia({audio:true});
    mediaRec=new MediaRecorder(stream);recChunks=[];recording=true;
    document.getElementById('recInd').classList.add('show');
    document.getElementById('recBtn').classList.add('active');
    document.getElementById('recBtn').textContent='â¹';
    mediaRec.ondataavailable=e=>recChunks.push(e.data);
    mediaRec.onstop=()=>{
      const blob=new Blob(recChunks,{type:'audio/webm'});
      const reader=new FileReader();
      reader.onload=ev=>{
        notes.push({text:'',time:stamp(),iso:isoNow(),cat:activeCat,pinned:false,replyTo:replyTo?.text||null,audio:ev.target.result,reminder:null,reminderFired:false});
        renderFeed();triggerSave();
      };
      reader.readAsDataURL(blob);
      stream.getTracks().forEach(t=>t.stop());
    };
    mediaRec.start();
  }catch(e){alert('Microphone not available');}
}
function stopRecord(){
  if(mediaRec&&recording){mediaRec.stop();recording=false;document.getElementById('recInd').classList.remove('show');document.getElementById('recBtn').classList.remove('active');document.getElementById('recBtn').textContent='ğŸ™';cancelReply();}
}

// â”€â”€ FILE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function handleFile(e){
  const file=e.target.files[0];if(!file)return;
  const reader=new FileReader();
  reader.onload=ev=>{notes.push({text:'',time:stamp(),iso:isoNow(),cat:activeCat,pinned:false,replyTo:null,image:ev.target.result,reminder:pendingReminder,reminderFired:false});pendingReminder=null;e.target.value='';renderFeed();triggerSave();};
  reader.readAsDataURL(file);
}

// â”€â”€ CHECKLIST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function parseChecklist(text){
  const lines=text.split('\n');
  const items=lines.filter(l=>/^[â˜âœ“âœ…]\s|^- \[[ x]\]/i.test(l));
  if(items.length<2)return null;
  return items.map(l=>({text:l.replace(/^[â˜âœ“âœ…]\s|^- \[[ x]\]\s*/i,'').trim(),checked:/^[âœ“âœ…]|^- \[x\]/i.test(l)}));
}

// â”€â”€ SEND â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function sendMessage(){
  const input=document.getElementById('msgInput'),text=input.value.trim();
  if(!text)return;
  const btn=document.getElementById('sendBtn');
  btn.style.transform='scale(.85)';setTimeout(()=>btn.style.transform='',150);

  const note={text,time:stamp(),iso:isoNow(),cat:activeCat,pinned:false,replyTo:replyTo?.text||null,reminder:pendingReminder,reminderFired:false};

  if(isURL(text)){
    note.text='';note.urlPreview={url:text,title:domain(text),desc:'',img:''};
    notes.push(note);input.value='';input.style.height='auto';cancelReply();pendingReminder=null;
    document.getElementById('remBtn').classList.remove('active');
    renderFeed();triggerSave();
    fetchPreview(text).then(p=>{note.urlPreview=p;renderFeed();triggerSave();});
    return;
  }
  const cl=parseChecklist(text);
  if(cl){note.checklist=cl;note.text=text.split('\n')[0]||'';}
  notes.push(note);input.value='';input.style.height='auto';
  cancelReply();pendingReminder=null;document.getElementById('remBtn').classList.remove('active');
  renderFeed();triggerSave();
}

async function fetchPreview(url){
  try{const res=await fetch('/.netlify/functions/notes',{method:'POST',headers:{'Content-Type':'application/json','X-Action':'preview'},body:JSON.stringify({url})});return await res.json();}
  catch(e){return{url,title:domain(url),desc:'',img:''};}
}

// â”€â”€ SHARE WHATSAPP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function shareWhatsApp(text){
  const encoded=encodeURIComponent(text);
  window.open('https://wa.me/?text='+encoded,'_blank');
}

// â”€â”€ EXPORT PDF â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function exportPDF(){
  const printWin=window.open('','_blank');
  const rows=notes.filter(n=>n.text||n.urlPreview||n.checklist).map(n=>`
    <div style="border:1px solid #ddd;border-radius:10px;padding:12px;margin-bottom:10px;page-break-inside:avoid;">
      ${n.cat&&n.cat!=='general'?`<span style="background:#f5a623;color:#1c1a17;border-radius:20px;padding:2px 8px;font-size:10px;font-weight:700;text-transform:uppercase;">${n.cat}</span><br><br>`:''}
      ${n.replyTo?`<div style="border-left:3px solid #f5a623;padding:3px 8px;margin-bottom:6px;font-size:11px;color:#888;">â†© ${n.replyTo}</div>`:''}
      ${n.text?`<div style="font-size:14px;line-height:1.6;white-space:pre-wrap;">${esc(n.text)}</div>`:''}
      ${n.checklist?n.checklist.map(c=>`<div style="font-size:13px;margin:2px 0;">${c.checked?'â˜‘':'â˜'} ${esc(c.text)}</div>`).join(''):''}
      ${n.urlPreview?`<div style="font-size:12px;color:#1d4ed8;margin-top:4px;">ğŸ”— ${esc(n.urlPreview.title||n.urlPreview.url)}</div>`:''}
      <div style="font-size:10px;color:#aaa;margin-top:6px;text-align:right;">${n.time} Â· ${n.cat||'general'}</div>
    </div>
  `).join('');
  printWin.document.write(`<!DOCTYPE html><html><head><meta charset="UTF-8"><title>HiveNote Export</title>
    <style>body{font-family:'Segoe UI',sans-serif;padding:30px;max-width:700px;margin:auto;color:#1c1a17;}
    h1{font-size:1.4rem;margin-bottom:20px;color:#d4881a;}
    @media print{button{display:none;}}</style></head>
    <body><h1>ğŸ HiveNote Export â€” ${new Date().toLocaleDateString('he-IL')}</h1>${rows}
    <button onclick="window.print()" style="background:#f5a623;border:none;border-radius:8px;padding:10px 20px;font-size:14px;cursor:pointer;font-weight:700;">ğŸ–¨ Print / Save PDF</button>
    </body></html>`);
  printWin.document.close();
}

// â”€â”€ REPLY/PIN/DUP/DELETE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function startReply(i){replyTo={i,text:notes[i].text||notes[i].urlPreview?.title||'ğŸ™ Voice'};document.getElementById('replyTxt').textContent='â†© '+replyTo.text.substring(0,55);document.getElementById('replyBar').classList.add('show');document.getElementById('msgInput').focus();}
function cancelReply(){replyTo=null;document.getElementById('replyBar').classList.remove('show');}
function togglePin(i){notes[i].pinned=!notes[i].pinned;renderFeed();triggerSave();}
function dupNote(i){notes.push({...notes[i],time:stamp(),iso:isoNow(),pinned:false,reminderFired:false});renderFeed();triggerSave();}
function delNote(i){
  const el=document.getElementById('wrap-'+i);
  if(el){el.style.transition='opacity .18s,transform .18s';el.style.opacity='0';el.style.transform='scale(.95)';}
  setTimeout(()=>{notes.splice(i,1);renderFeed();triggerSave();},190);
}

// â”€â”€ EDIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function startEdit(i){
  const bubble=document.getElementById('bubble-'+i),note=notes[i];
  const d=dir(note.text||'');
  const catOpts=['general','work','personal','todo','urgent'].map(c=>`<option value="${c}" ${note.cat===c?'selected':''}>${c}</option>`).join('');
  bubble.innerHTML=`<div class="edit-wrap">
    <textarea class="edit-ta" id="edt-${i}" style="direction:${d};text-align:${d==='rtl'?'right':'left'}">${esc(note.text||'')}</textarea>
    <div class="edit-row">
      <select class="edit-sel" id="eCat-${i}">${catOpts}</select>
      <input type="datetime-local" class="edit-dt" id="eRem-${i}" value="${note.reminder?note.reminder.slice(0,16):''}">
      <button class="e-save" onclick="saveEdit(${i})">Save</button>
      <button class="e-cancel" onclick="renderFeed()">Cancel</button>
    </div>
  </div>`;
  const ta=document.getElementById('edt-'+i);ta.focus();ta.style.height=ta.scrollHeight+'px';
}
function saveEdit(i){
  const ta=document.getElementById('edt-'+i);
  const cat=document.getElementById('eCat-'+i).value;
  const rem=document.getElementById('eRem-'+i).value;
  if(ta.value.trim())notes[i].text=ta.value.trim();
  notes[i].cat=cat;notes[i].reminder=rem||null;notes[i].reminderFired=false;
  const cl=parseChecklist(notes[i].text);if(cl){notes[i].checklist=cl;notes[i].text='';}
  renderFeed();triggerSave();
}

// â”€â”€ STATS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showStats(){
  const cats={};notes.forEach(n=>{cats[n.cat]=(cats[n.cat]||0)+1;});
  document.getElementById('statsContent').innerHTML=[
    ['ğŸ“ Total',notes.length],['ğŸ“Œ Pinned',notes.filter(n=>n.pinned).length],
    ['ğŸ’¼ Work',cats.work||0],['ğŸ‘¤ Personal',cats.personal||0],
    ['âœ… Todo',cats.todo||0],['ğŸ”¥ Urgent',cats.urgent||0],
    ['ğŸ”” Reminders',notes.filter(n=>n.reminder).length],
    ['ğŸ”— URLs',notes.filter(n=>n.urlPreview).length],
    ['ğŸ–¼ Images',notes.filter(n=>n.image).length],
    ['ğŸ™ Voice',notes.filter(n=>n.audio).length],
  ].map(([l,v])=>`<div class="stat-row"><span class="stat-lbl">${l}</span><span class="stat-val">${v}</span></div>`).join('');
  document.getElementById('statsOverlay').classList.add('show');
}
function closeOv(id){document.getElementById(id).classList.remove('show');}

// â”€â”€ RENDER PINNED â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderPinned(){
  const pinned=notes.filter(n=>n.pinned);
  const strip=document.getElementById('pinnedStrip');
  document.getElementById('pinnedRow').innerHTML='';
  if(!pinned.length){strip.classList.remove('vis');return;}
  strip.classList.add('vis');
  pinned.forEach(note=>{
    const i=notes.indexOf(note);
    const card=document.createElement('div');card.className='pinned-card';
    const prev=(note.urlPreview?.title||note.text||note.audio?'ğŸ™ Voice':'ğŸ“').substring(0,45);
    card.innerHTML=`<span>${esc(prev)}</span><button onclick="togglePin(${i})" title="Unpin">âœ•</button>`;
    document.getElementById('pinnedRow').appendChild(card);
  });
}

// â”€â”€ RENDER FEED â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderFeed(){
  const feed=document.getElementById('feed');
  renderPinned();
  const catLabels={work:'ğŸ’¼ Work',personal:'ğŸ‘¤ Personal',todo:'âœ… Todo',urgent:'ğŸ”¥ Urgent'};

  let vis=notes.filter(n=>{
    if(n.pinned)return false;
    if(activeFilter!=='all'&&n.cat!==activeFilter)return false;
    if(searchQ){const h=((n.text||'')+' '+(n.urlPreview?.title||'')).toLowerCase();if(!h.includes(searchQ))return false;}
    return true;
  });
  if(sortNewest)vis=[...vis].reverse();

  feed.innerHTML='';
  if(!notes.length){feed.innerHTML='<div class="empty-state"><div class="empty-bee">ğŸ</div><div class="empty-t">The hive is empty</div><div class="empty-s">Add your first note below</div></div>';return;}
  if(!vis.length){feed.innerHTML='<div class="empty-state"><div class="empty-bee" style="font-size:2rem">ğŸ”</div><div class="empty-t">No results</div><div class="empty-s">Try a different filter</div></div>';return;}

  let lastDate=null;
  vis.forEach(note=>{
    const i=notes.indexOf(note);
    const d=dir(note.text||'');
    const dl=dateLabel(note.iso);
    if(dl!==lastDate){
      const sep=document.createElement('div');sep.className='date-sep';
      sep.innerHTML=`<span class="date-lbl">${dl}</span>`;feed.appendChild(sep);lastDate=dl;
    }

    const wrap=document.createElement('div');wrap.className=`msg-wrap ${d}`;wrap.id='wrap-'+i;

    // actions
    const actions=document.createElement('div');actions.className='msg-actions';
    const noteText=note.text||note.urlPreview?.title||'';
    actions.innerHTML=`
      <button class="act-btn" onclick="startReply(${i})">â†© Reply</button>
      <button class="act-btn" onclick="startEdit(${i})">âœ Edit</button>
      <button class="act-btn" onclick="dupNote(${i})">â§‰ Copy</button>
      ${noteText?`<button class="act-btn" onclick="shareWhatsApp(\`${noteText.replace(/`/g,'')}\`)">ğŸ“± WA</button>`:''}
      <button class="act-btn pin-b" onclick="togglePin(${i})">${note.pinned?'ğŸ“Œ Unpin':'ğŸ“Œ Pin'}</button>
      <button class="act-btn del" onclick="delNote(${i})">ğŸ—‘</button>
    `;

    const bubble=document.createElement('div');
    bubble.className='bubble'+(note.cat&&note.cat!=='general'?' cat-'+note.cat:'');
    bubble.id='bubble-'+i;

    // cat badge
    if(note.cat&&note.cat!=='general'){
      const b=document.createElement('div');b.className='cat-badge '+note.cat;b.textContent=catLabels[note.cat];bubble.appendChild(b);
      bubble.appendChild(document.createElement('br'));
    }
    // reminder
    if(note.reminder){
      const rd=new Date(note.reminder),over=new Date()>rd&&!note.reminderFired;
      const rp=document.createElement('div');rp.className='rem-badge'+(over?' over':'');
      rp.textContent='ğŸ”” '+rd.toLocaleDateString('he-IL')+' '+rd.toLocaleTimeString('he-IL',{hour:'2-digit',minute:'2-digit'});
      bubble.appendChild(rp);bubble.appendChild(document.createElement('br'));
    }
    // reply quote
    if(note.replyTo){const rq=document.createElement('div');rq.className='reply-quote';rq.textContent='â†© '+note.replyTo;bubble.appendChild(rq);}
    // image
    if(note.image){const img=document.createElement('img');img.className='bubble-img';img.src=note.image;img.onclick=()=>{document.getElementById('imgSrc').src=note.image;document.getElementById('imgOverlay').classList.add('show');};bubble.appendChild(img);}
    // url card
    if(note.urlPreview){
      const p=note.urlPreview;
      const card=document.createElement('div');card.className='url-card';card.onclick=()=>window.open(p.url,'_blank');
      card.innerHTML=`${p.img?`<img class="url-card-img" src="${esc(p.img)}" onerror="this.style.display='none'" alt="">`:''}
        <div class="url-card-body"><div class="url-card-title">${esc(p.title||p.url)}</div>${p.desc?`<div class="url-card-desc">${esc(p.desc)}</div>`:''}<div class="url-card-domain">ğŸ”— ${esc(domain(p.url))}</div></div>`;
      bubble.appendChild(card);
    }
    // voice
    if(note.audio){
      const vn=document.createElement('div');vn.className='voice-note';
      const playBtn=document.createElement('button');playBtn.className='voice-play';playBtn.textContent='â–¶';
      let audioEl=null;
      playBtn.onclick=()=>{
        if(audioEl&&!audioEl.paused){audioEl.pause();playBtn.textContent='â–¶';return;}
        audioEl=new Audio(note.audio);audioEl.play();playBtn.textContent='â¸';
        audioEl.onended=()=>playBtn.textContent='â–¶';
      };
      vn.innerHTML=`<div class="voice-wave"><span style="height:8px"></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></div><span class="voice-dur">ğŸ™ Voice</span>`;
      vn.insertBefore(playBtn,vn.firstChild);bubble.appendChild(vn);
    }
    // checklist
    if(note.checklist?.length){
      const ul=document.createElement('ul');ul.className='checklist';
      note.checklist.forEach((item,ci)=>{
        const li=document.createElement('li');if(item.checked)li.classList.add('done');
        const cb=document.createElement('input');cb.type='checkbox';cb.checked=item.checked;
        cb.onchange=()=>{notes[i].checklist[ci].checked=cb.checked;li.classList.toggle('done',cb.checked);triggerSave();};
        const sp=document.createElement('span');sp.textContent=item.text;
        li.appendChild(cb);li.appendChild(sp);ul.appendChild(li);
      });
      bubble.appendChild(ul);
    }else if(note.text){
      const txt=document.createElement('div');txt.className='msg-text '+d;txt.innerHTML=hl(note.text,searchQ);bubble.appendChild(txt);
    }
    // time
    const time=document.createElement('div');time.className='msg-time';
    time.innerHTML=note.time+(note.pinned?' ğŸ“Œ':'');bubble.appendChild(time);

    wrap.appendChild(actions);wrap.appendChild(bubble);feed.appendChild(wrap);
  });

  if(sortNewest)feed.scrollTop=0;else feed.scrollTop=feed.scrollHeight;
}

// â”€â”€ INPUT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const msgInput=document.getElementById('msgInput');
msgInput.addEventListener('input',()=>{
  msgInput.style.height='auto';
  msgInput.style.height=Math.min(msgInput.scrollHeight,96)+'px';
  const d=dir(msgInput.value);msgInput.style.direction=d;msgInput.style.textAlign=d==='rtl'?'right':'left';
});
msgInput.addEventListener('keydown',e=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendMessage();}});

// â”€â”€ SAVE/LOAD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const saveDot=document.getElementById('saveDot');
let saveTimer;
function triggerSave(){clearTimeout(saveTimer);saveDot.className='save-dot saving';saveTimer=setTimeout(saveNotes,1500);}
async function loadNotes(){
  try{const res=await fetch('/.netlify/functions/notes');const data=await res.json();notes=data.notes||[];renderFeed();saveDot.className='save-dot';checkReminders();}
  catch(e){saveDot.className='save-dot err';}
}
async function saveNotes(){
  try{await fetch('/.netlify/functions/notes',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({notes})});saveDot.className='save-dot';}
  catch(e){saveDot.className='save-dot err';}
}
</script>
</body>
</html>
HTMLEOF