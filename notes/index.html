<!DOCTYPE html>
<html lang="he">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>My Notes</title>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: #0d0d0d;
    color: #c8c8c8;
    font-family: 'Courier New', Courier, monospace;
    height: 100vh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  /* TOP BAR */
  .topbar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 20px;
    background: #111;
    border-bottom: 1px solid #222;
    font-size: 0.8rem;
    color: #555;
    flex-shrink: 0;
  }
  .topbar .title { color: #4ec9b0; font-size: 0.95rem; letter-spacing: 2px; }
  .topbar .clock { color: #569cd6; font-size: 0.85rem; }
  .topbar .status { font-size: 0.75rem; }
  .topbar .status.saving { color: #dcdcaa; }
  .topbar .status.saved  { color: #4ec9b0; }
  .topbar .status.err    { color: #f44747; }

  /* TOOLBAR */
  .toolbar {
    display: flex;
    gap: 6px;
    padding: 6px 16px;
    background: #111;
    border-bottom: 1px solid #1e1e1e;
    flex-shrink: 0;
    flex-wrap: wrap;
  }
  .toolbar button {
    background: #1e1e1e;
    border: 1px solid #333;
    color: #9cdcfe;
    border-radius: 4px;
    padding: 3px 10px;
    font-size: 0.8rem;
    font-family: 'Courier New', monospace;
    cursor: pointer;
    transition: background 0.15s;
  }
  .toolbar button:hover { background: #264f78; border-color: #569cd6; }
  .toolbar .sep { width: 1px; background: #333; margin: 0 4px; }

  /* NOTES AREA */
  #notes-container {
    flex: 1;
    overflow-y: auto;
    padding: 16px 20px;
    display: flex;
    flex-direction: column;
    gap: 2px;
  }

  .note-line {
    display: flex;
    gap: 10px;
    align-items: flex-start;
    padding: 2px 0;
    border-radius: 3px;
    transition: background 0.1s;
  }
  .note-line:hover { background: #151515; }

  .note-time {
    color: #569cd6;
    font-size: 0.75rem;
    white-space: nowrap;
    padding-top: 3px;
    flex-shrink: 0;
    opacity: 0.7;
    min-width: 75px;
  }

  .note-text {
    flex: 1;
    background: transparent;
    border: none;
    outline: none;
    color: #c8c8c8;
    font-family: 'Courier New', Courier, monospace;
    font-size: 1.05rem;
    line-height: 1.6;
    resize: none;
    overflow: hidden;
    min-height: 26px;
    width: 100%;
    padding: 0;
  }

  /* RTL/LTR detection */
  .note-text.rtl { direction: rtl; text-align: right; }
  .note-text.ltr { direction: ltr; text-align: left; }

  /* New line input at bottom */
  .new-line-wrap {
    display: flex;
    gap: 10px;
    align-items: center;
    padding: 8px 20px;
    border-top: 1px solid #1a1a1a;
    background: #0d0d0d;
    flex-shrink: 0;
  }
  .new-line-wrap .prompt { color: #4ec9b0; font-size: 0.85rem; white-space: nowrap; }
  #newInput {
    flex: 1;
    background: transparent;
    border: none;
    outline: none;
    color: #d4d4d4;
    font-family: 'Courier New', Courier, monospace;
    font-size: 1.05rem;
    caret-color: #4ec9b0;
  }

  /* Scrollbar */
  #notes-container::-webkit-scrollbar { width: 6px; }
  #notes-container::-webkit-scrollbar-track { background: #0d0d0d; }
  #notes-container::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }

  .empty-hint { color: #333; font-size: 0.85rem; text-align: center; margin-top: 40px; }
</style>
</head>
<body>

<div class="topbar">
  <span class="title">> MY NOTES</span>
  <span class="clock" id="clock"></span>
  <span class="status" id="status">auto-save on</span>
</div>

<div class="toolbar">
  <button onclick="addSpecialLine('• ')">• bullet</button>
  <button onclick="addSpecialLine('☐ ')">☐ task</button>
  <button onclick="addSpecialLine('✓ ')">✓ done</button>
  <div class="sep"></div>
  <button onclick="addSpecialLine('──────────────────')">─ divider</button>
  <div class="sep"></div>
  <button onclick="clearAll()" style="color:#f44747;border-color:#f44747;">✕ clear all</button>
</div>

<div id="notes-container">
  <div class="empty-hint" id="emptyHint">Start typing below...</div>
</div>

<div class="new-line-wrap">
  <span class="prompt">&gt;_</span>
  <input type="text" id="newInput" placeholder="Type and press Enter..." autofocus autocomplete="off" spellcheck="true">
</div>

<script>
// ── Clock ────────────────────────────────────────────────────
function updateClock() {
  const now = new Date();
  document.getElementById('clock').textContent =
    now.toLocaleDateString('he-IL') + ' ' +
    now.toLocaleTimeString('he-IL', {hour:'2-digit', minute:'2-digit', second:'2-digit'});
}
setInterval(updateClock, 1000);
updateClock();

// ── RTL detection ────────────────────────────────────────────
function detectDir(text) {
  const hebrewRe = /[\u0590-\u05FF]/;
  return hebrewRe.test(text) ? 'rtl' : 'ltr';
}

// ── Notes data ───────────────────────────────────────────────
let notes = []; // [{time, text}]

function getStamp() {
  const now = new Date();
  return now.toLocaleTimeString('he-IL', {hour:'2-digit', minute:'2-digit'});
}

function renderNotes() {
  const container = document.getElementById('notes-container');
  const hint = document.getElementById('emptyHint');
  container.innerHTML = '';

  if (notes.length === 0) {
    container.appendChild(hint || (() => {
      const d = document.createElement('div');
      d.className = 'empty-hint';
      d.textContent = 'Start typing below...';
      return d;
    })());
    return;
  }

  notes.forEach((note, i) => {
    const line = document.createElement('div');
    line.className = 'note-line';

    const timeEl = document.createElement('span');
    timeEl.className = 'note-time';
    timeEl.textContent = note.time;

    const textEl = document.createElement('textarea');
    textEl.className = 'note-text ' + detectDir(note.text);
    textEl.value = note.text;
    textEl.rows = 1;
    autoResize(textEl);

    textEl.addEventListener('input', () => {
      notes[i].text = textEl.value;
      textEl.className = 'note-text ' + detectDir(textEl.value);
      autoResize(textEl);
      triggerSave();
    });

    textEl.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        document.getElementById('newInput').focus();
      }
      if (e.key === 'Backspace' && textEl.value === '') {
        e.preventDefault();
        notes.splice(i, 1);
        renderNotes();
        triggerSave();
        document.getElementById('newInput').focus();
      }
    });

    line.appendChild(timeEl);
    line.appendChild(textEl);
    container.appendChild(line);
  });

  // scroll to bottom
  container.scrollTop = container.scrollHeight;
}

function autoResize(el) {
  el.style.height = 'auto';
  el.style.height = el.scrollHeight + 'px';
}

function addLine(text) {
  if (!text.trim() && text !== '──────────────────') return;
  notes.push({ time: getStamp(), text });
  renderNotes();
  triggerSave();
}

function addSpecialLine(prefix) {
  addLine(prefix);
  document.getElementById('newInput').focus();
}

function clearAll() {
  if (!confirm('Clear all notes?')) return;
  notes = [];
  renderNotes();
  triggerSave();
}

// ── New input handler ────────────────────────────────────────
document.getElementById('newInput').addEventListener('keydown', (e) => {
  if (e.key === 'Enter') {
    const val = e.target.value;
    addLine(val);
    e.target.value = '';
  }
});

// auto-detect direction as user types
document.getElementById('newInput').addEventListener('input', (e) => {
  e.target.style.direction = detectDir(e.target.value) === 'rtl' ? 'rtl' : 'ltr';
  e.target.style.textAlign = detectDir(e.target.value) === 'rtl' ? 'right' : 'left';
});

// ── Save / Load ──────────────────────────────────────────────
const status = document.getElementById('status');
let saveTimer;

function triggerSave() {
  clearTimeout(saveTimer);
  status.className = 'status saving';
  status.textContent = 'saving...';
  saveTimer = setTimeout(saveNotes, 1500);
}

async function loadNotes() {
  status.textContent = 'loading...';
  try {
    const res = await fetch('/.netlify/functions/notes');
    const data = await res.json();
    notes = data.notes || [];
    renderNotes();
    status.className = 'status';
    status.textContent = 'auto-save on';
  } catch(e) {
    status.textContent = 'load failed';
  }
}

async function saveNotes() {
  try {
    await fetch('/.netlify/functions/notes', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ notes })
    });
    status.className = 'status saved';
    status.textContent = 'saved ✓';
    setTimeout(() => { status.className = 'status'; status.textContent = 'auto-save on'; }, 2000);
  } catch(e) {
    status.className = 'status err';
    status.textContent = 'save failed!';
  }
}

loadNotes();
</script>
</body>
</html>
