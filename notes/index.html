<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>My Notes</title>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: 'Segoe UI', sans-serif; background: #1a1a2e; color: #eee; min-height: 100vh; display: flex; align-items: center; justify-content: center; }

  /* LOGIN */
  .login-box { background: #16213e; border: 1px solid #0f3460; border-radius: 12px; padding: 40px; width: 340px; box-shadow: 0 8px 32px rgba(0,0,0,0.4); }
  .login-box h2 { text-align: center; margin-bottom: 28px; color: #e94560; font-size: 1.4rem; letter-spacing: 1px; }
  .login-box label { display: block; margin-bottom: 6px; font-size: 0.85rem; color: #aaa; }
  .login-box input { width: 100%; padding: 10px 14px; border-radius: 8px; border: 1px solid #0f3460; background: #0f3460; color: #eee; font-size: 1rem; margin-bottom: 18px; outline: none; transition: border 0.2s; }
  .login-box input:focus { border-color: #e94560; }
  .login-box button { width: 100%; padding: 11px; background: #e94560; border: none; border-radius: 8px; color: #fff; font-size: 1rem; cursor: pointer; transition: background 0.2s; }
  .login-box button:hover { background: #c73652; }
  .error { background: #3d0000; color: #ff6b6b; border-radius: 6px; padding: 10px 14px; margin-bottom: 16px; font-size: 0.88rem; }
  .step-indicator { text-align: center; margin-bottom: 20px; color: #555; font-size: 0.8rem; }
  .step-indicator span { color: #e94560; font-weight: bold; }

  /* NOTES */
  .notes-wrap { width: 100%; max-width: 900px; padding: 20px; display: none; }
  .notes-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 14px; }
  .notes-header h2 { color: #e94560; font-size: 1.2rem; }
  .notes-header a { color: #555; font-size: 0.82rem; text-decoration: none; cursor: pointer; transition: color 0.2s; }
  .notes-header a:hover { color: #e94560; }
  textarea { width: 100%; height: calc(100vh - 120px); background: #16213e; color: #eee; border: 1px solid #0f3460; border-radius: 10px; padding: 20px; font-size: 1rem; line-height: 1.7; resize: none; outline: none; font-family: 'Segoe UI', sans-serif; transition: border 0.2s; }
  textarea:focus { border-color: #e94560; }
  .save-status { font-size: 0.78rem; color: #555; margin-top: 8px; text-align: right; transition: color 0.3s; }
  .save-status.saving { color: #f0a500; }
  .save-status.saved { color: #4caf50; }
  .save-status.error { color: #ff6b6b; }
</style>
</head>
<body>

<!-- STEP 1: Username + Password -->
<div class="login-box" id="step1">
  <h2>üîí Notes Login</h2>
  <div class="step-indicator">Step <span>1</span> of 2</div>
  <div class="error" id="err1" style="display:none"></div>
  <label>Username</label>
  <input type="text" id="username" autocomplete="off" placeholder="Username">
  <label>Password</label>
  <input type="password" id="password" autocomplete="off" placeholder="Password">
  <button onclick="checkStep1()">Continue</button>
</div>

<!-- STEP 2: PIN -->
<div class="login-box" id="step2" style="display:none">
  <h2>üîê Verification</h2>
  <div class="step-indicator">Step <span>2</span> of 2</div>
  <div class="error" id="err2" style="display:none"></div>
  <label>PIN</label>
  <input type="password" id="pin" autocomplete="off" placeholder="Enter your PIN">
  <button onclick="checkStep2()">Verify</button>
</div>

<!-- NOTES -->
<div class="notes-wrap" id="notesWrap">
  <div class="notes-header">
    <h2>üìù My Notes</h2>
    <a onclick="logout()">Logout</a>
  </div>
  <textarea id="notepad" placeholder="Start typing..."></textarea>
  <div class="save-status" id="status">Auto-save enabled</div>
</div>

<script>
// ‚îÄ‚îÄ Security config ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const USERNAME   = 'ibee';
const PASS_SALT  = 'deeb1f9fdc8a5c9ffda5ae78848dd71c';
const PASS_HASH  = 'a751f0093d4236715d0155eaa0ba741dcefa64d960e71ffb22c04d0c924b88df';
const PIN_SALT   = 'b07951bdbff02fa68a96e1c74c447bfa';
const PIN_HASH   = 'b17e91a9794022c063904c3a552e66fe4e93b2665d80a53dc94f8f77857c74e0';
const MAX_ATT    = 5;
const LOCK_TIME  = 600000; // 10 min ms
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

let attempts = parseInt(sessionStorage.getItem('att') || '0');
let lockUntil = parseInt(sessionStorage.getItem('lockUntil') || '0');

async function sha256(salt, val) {
  const msg = new TextEncoder().encode(salt + val);
  const buf = await crypto.subtle.digest('SHA-256', msg);
  return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2,'0')).join('');
}

function isLocked() {
  if (attempts >= MAX_ATT && Date.now() < lockUntil) return true;
  if (Date.now() >= lockUntil) { attempts = 0; sessionStorage.setItem('att','0'); }
  return false;
}

function addFail() {
  attempts++;
  sessionStorage.setItem('att', attempts);
  if (attempts >= MAX_ATT) {
    lockUntil = Date.now() + LOCK_TIME;
    sessionStorage.setItem('lockUntil', lockUntil);
  }
}

function showError(id, msg) {
  const el = document.getElementById(id);
  el.textContent = msg;
  el.style.display = 'block';
}

async function checkStep1() {
  if (isLocked()) { showError('err1', 'Too many attempts. Wait 10 minutes.'); return; }
  const user = document.getElementById('username').value.trim();
  const pass = document.getElementById('password').value;
  const hash = await sha256(PASS_SALT, pass);
  if (user === USERNAME && hash === PASS_HASH) {
    attempts = 0; sessionStorage.setItem('att','0');
    document.getElementById('step1').style.display = 'none';
    document.getElementById('step2').style.display = 'block';
    document.getElementById('pin').focus();
  } else {
    addFail();
    const rem = MAX_ATT - attempts;
    showError('err1', rem > 0 ? `Wrong credentials. ${rem} attempts left.` : 'Locked. Wait 10 minutes.');
  }
}

async function checkStep2() {
  if (isLocked()) { showError('err2', 'Too many attempts. Wait 10 minutes.'); return; }
  const pin = document.getElementById('pin').value;
  const hash = await sha256(PIN_SALT, pin);
  if (hash === PIN_HASH) {
    attempts = 0; sessionStorage.setItem('att','0');
    document.getElementById('step2').style.display = 'none';
    document.getElementById('notesWrap').style.display = 'block';
    loadNotes();
  } else {
    addFail();
    const rem = MAX_ATT - attempts;
    showError('err2', rem > 0 ? `Wrong PIN. ${rem} attempts left.` : 'Locked. Wait 10 minutes.');
  }
}

function logout() {
  sessionStorage.clear();
  location.reload();
}

// Enter key support
document.addEventListener('keydown', e => {
  if (e.key !== 'Enter') return;
  if (document.getElementById('step1').style.display !== 'none') checkStep1();
  else if (document.getElementById('step2').style.display !== 'none') checkStep2();
});

// ‚îÄ‚îÄ Notes save/load ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const pad = document.getElementById('notepad');
const status = document.getElementById('status');
let saveTimer;

async function loadNotes() {
  status.textContent = 'Loading...';
  try {
    const res = await fetch('/.netlify/functions/notes');
    const data = await res.json();
    pad.value = data.text || '';
    status.textContent = 'Auto-save enabled';
  } catch(e) {
    status.textContent = 'Failed to load notes.';
  }
}

pad.addEventListener('input', () => {
  clearTimeout(saveTimer);
  status.className = 'save-status saving';
  status.textContent = 'Saving...';
  saveTimer = setTimeout(saveNotes, 1500);
});

async function saveNotes() {
  try {
    const res = await fetch('/.netlify/functions/notes', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ text: pad.value })
    });
    if (res.ok) {
      status.className = 'save-status saved';
      status.textContent = 'Saved ‚úì';
      setTimeout(() => { status.className = 'save-status'; status.textContent = 'Auto-save enabled'; }, 2000);
    }
  } catch(e) {
    status.className = 'save-status error';
    status.textContent = 'Save failed!';
  }
}
</script>
</body>
</html>
